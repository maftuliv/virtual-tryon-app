# Claude Code Rules for Virtual Try-On App

## üö® CRITICAL RULES - ALWAYS FOLLOW

### 1. Production-First Mindset
**ALWAYS assume user wants production deployment unless explicitly stated otherwise**
- ‚ùå NEVER focus on localhost/local development by default
- ‚úÖ ALWAYS implement features for production (Railway/taptolook.net)
- ‚úÖ Test locally but DEPLOY to production immediately
- ‚úÖ Admin panel must work from ANY device/location (not just localhost)

### 2. Database Operations
**ALL database operations MUST use `db_transaction` context manager**
```python
# ‚úÖ CORRECT
from backend.utils.db_helpers import db_transaction

with db_transaction(self.db) as cursor:
    cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
    result = cursor.fetchone()
# Transaction auto-commits on success, auto-rolls back on error

# ‚ùå WRONG - Never do this
cursor = self.db.cursor()
cursor.execute("...")  # Can cause "current transaction is aborted" errors
```

### 3. Authentication & Security
**CRITICAL: Cookie-based auth must work on production (HTTPS)**
- ‚úÖ `Secure=True` on production (HTTPS required)
- ‚úÖ `Secure=False` only on localhost (for dev)
- ‚úÖ `credentials: 'include'` in ALL fetch() calls
- ‚úÖ CORS `supports_credentials=True` with explicit origins (NOT `*`)
- ‚úÖ Admin routes MUST verify role on SERVER before serving HTML

### 4. CORS Configuration
**When using credentials (cookies), NEVER use wildcard origins**
```python
# ‚úÖ CORRECT
CORS(app, resources={
    r"/*": {
        "origins": ["https://taptolook.net", "http://localhost:5000"],
        "supports_credentials": True,
    }
})

# ‚ùå WRONG
CORS(app, resources={
    r"/*": {
        "origins": "*",  # Incompatible with credentials!
        "supports_credentials": True,
    }
})
```

### 5. Deployment Process
**ALWAYS follow this sequence for production changes**
1. Make changes locally
2. Test locally (if needed)
3. ‚úÖ **IMMEDIATELY commit and push to GitHub**
4. ‚úÖ **VERIFY Railway deployment status**
5. ‚úÖ **WAIT for Railway to finish deploying (2-3 min)**
6. ‚úÖ **TEST on production (taptolook.net)**
7. ‚ùå NEVER assume it's deployed without verification

### 6. Error Handling & Debugging
**When user reports errors, IMMEDIATELY analyze production logs**
- ‚úÖ Ask user to check Railway logs or provide screenshots
- ‚úÖ Check Network tab (F12) for actual request/response
- ‚úÖ Verify cookies are being sent in requests
- ‚ùå NEVER assume local behavior matches production

### 7. Admin Panel Security
**Admin panel MUST be protected at SERVER level**
```python
# ‚úÖ CORRECT - Server-side check before serving HTML
@app.route("/admin")
@require_admin_page  # Checks cookie, redirects if unauthorized
def serve_admin(current_user):
    return send_file("admin.html")

# ‚ùå WRONG - Client-side only
@app.route("/admin")
def serve_admin():
    return send_file("admin.html")  # Anyone can access!
```

### 8. Professional Standards
**User expects professional enterprise-level code**
- ‚úÖ Security first (XSS, CSRF, SQL injection protection)
- ‚úÖ Proper error handling with user-friendly messages
- ‚úÖ Audit logging for critical operations
- ‚úÖ Input validation on ALL endpoints
- ‚úÖ Rate limiting on sensitive endpoints
- ‚ùå NEVER skip security features "for simplicity"

### 9. Testing on Production
**After deployment, ALWAYS verify on production**
```bash
# ‚úÖ Deployment checklist:
1. git push ‚Üí GitHub
2. Check Railway dashboard for deployment status
3. Wait for "Active" status
4. Clear browser cache/cookies
5. Test feature on https://taptolook.net
6. Check Railway logs for errors
```

### 10. Cookie Configuration
**HTTP-only cookies must work in production environment**
```python
# ‚úÖ CORRECT - Conditional based on environment
is_localhost = request.host.startswith("localhost")
response.set_cookie(
    "auth_token",
    value=token,
    secure=not is_localhost,  # True on production (HTTPS)
    httponly=True,
    samesite="Strict",
    path="/",
)
```

## üéØ Project-Specific Rules

### Admin Panel Access
- Must work from ANY device (mobile, laptop, different locations)
- Protected by server-side role check (not just client-side)
- Uses HTTP-only cookies for security
- Redirects unauthorized users to home page

### Google OAuth Flow
- Sets both cookie AND returns token in JSON
- Cookie for HTML page access (/admin)
- Token in localStorage for API calls
- Must set cookie before redirect

### API Authentication
- Supports BOTH Authorization header AND cookie
- Decorator `@require_admin` checks both sources
- Graceful fallback if one source fails

### Railway Deployment
- Auto-deploys on push to main branch
- Takes 2-3 minutes to complete
- Check deployment status before testing
- Logs available in Railway dashboard

## üìã Pre-Deployment Checklist

Before committing admin/auth changes:
- [ ] Cookies work on HTTPS (production)
- [ ] CORS allows credentials with specific origins
- [ ] fetch() includes `credentials: 'include'`
- [ ] Server-side role verification exists
- [ ] Tested on production after deployment
- [ ] Error messages logged properly
- [ ] Security headers set correctly

## üö´ Common Mistakes to AVOID

1. ‚ùå Testing only on localhost and assuming production works
2. ‚ùå Using `origins: "*"` with `supports_credentials: True`
3. ‚ùå Forgetting `credentials: 'include'` in fetch calls
4. ‚ùå Setting `Secure=True` on localhost (blocks cookies on HTTP)
5. ‚ùå Not waiting for Railway deployment to complete
6. ‚ùå Client-side only admin protection
7. ‚ùå Using wildcard CORS in production
8. ‚ùå Not clearing cookies when testing auth changes

## üí° Best Practices

### When User Reports Bug
1. Ask for production URL and error screenshot
2. Check Railway logs immediately
3. Verify Network tab shows cookie/headers
4. Fix and deploy to production ASAP
5. Verify fix on production before confirming

### When Implementing Auth Feature
1. Design for production (HTTPS, secure cookies)
2. Add localhost compatibility (conditional Secure flag)
3. Test both localStorage AND cookie flows
4. Verify CORS settings allow credentials
5. Deploy and test on production

### When Adding Admin Feature
1. Server-side protection FIRST
2. Add API endpoint with @require_admin
3. Add frontend UI
4. Add audit logging
5. Test unauthorized access (must redirect/403)
6. Deploy and verify on production

## üìö Reference Files

- `backend/DATABASE_BEST_PRACTICES.md` - DB transaction patterns
- `backend/auth.py` - Auth decorators and cookie helpers
- `backend/api/admin.py` - Admin API endpoints
- `frontend/admin.js` - Admin panel frontend
- `README.md` - Deployment and security documentation

## üî• Emergency Rules

If user says "—Ç—ã –≤—Å–µ —Å–ª–æ–º–∞–ª" or similar:
1. **STOP** and analyze what broke
2. Check Railway deployment logs
3. Verify production behavior (not localhost)
4. Fix immediately and deploy
5. Test on production before confirming
6. Apologize professionally and learn from mistake

---

**Remember: User expects enterprise-grade, production-ready code that works globally, not just on localhost.**
