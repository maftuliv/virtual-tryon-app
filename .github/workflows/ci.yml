name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-type-check:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 mypy black isort pylint

      - name: Check code formatting with Black
        run: |
          black --check --diff backend/ || true

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff backend/ || true

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 backend/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings. Line length set to 120
          flake8 backend/ --count --exit-zero --max-complexity=15 --max-line-length=120 --statistics

      - name: Type checking with mypy
        run: |
          mypy backend/ --ignore-missing-imports --check-untyped-defs --no-strict-optional --exclude 'backend/app.py'
        continue-on-error: true

      - name: Pylint checks
        run: |
          pylint backend/ --max-line-length=120 --disable=C0114,C0115,C0116,R0913,R0914,W0703
        continue-on-error: true

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Security vulnerability scan with Safety
        run: |
          safety check --json || true

      - name: Security issues scan with Bandit
        run: |
          bandit -r backend/ -f json || true

  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate Pydantic configuration schema
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY || 'test_secret_key_for_ci_validation_purposes_only_32chars_min' }}
          NANOBANANA_API_KEY: test_api_key_for_validation
        run: |
          python -c "from backend.config import get_settings; settings = get_settings(); print('✅ Configuration validation passed')"

      - name: Check .env.example is up to date
        run: |
          # Ensure .env.example exists
          if [ ! -f .env.example ]; then
            echo "❌ .env.example file is missing!"
            exit 1
          fi
          echo "✅ .env.example exists"

  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: virtual_tryon_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-flask

      - name: Run tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/virtual_tryon_test
          JWT_SECRET_KEY: test_secret_key_for_ci_only_must_be_at_least_32_characters_long
          NANOBANANA_API_KEY: test_api_key
          FLASK_ENV: testing
        run: |
          # When tests are created, run:
          # pytest tests/ --cov=backend --cov-report=xml --cov-report=term
          echo "⚠️ No tests yet - create tests/ directory with pytest tests"
          echo "✅ Test step passed (placeholder)"

  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, validate-config]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check Python syntax
        run: |
          python -m py_compile backend/*.py
          python -m py_compile backend/**/*.py 2>/dev/null || true

      - name: Verify imports
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          JWT_SECRET_KEY: test_secret_key_for_ci_only_must_be_at_least_32_characters_long
          NANOBANANA_API_KEY: test_api_key
        run: |
          python -c "import backend.config; print('✅ backend.config imports successfully')"
          python -c "import backend.logger; print('✅ backend.logger imports successfully')"
          python -c "import backend.db_config; print('✅ backend.db_config imports successfully')"
          python -c "from backend.database import Feedback; print('✅ backend.database imports successfully')"
          python -c "from backend.auth import AuthManager; print('✅ backend.auth imports successfully')"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, security-scan, validate-config, test, build-check]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "CI checks completed!"
          echo ""
          echo "Results:"
          echo "  - Code Quality: ${{ needs.lint-and-type-check.result }}"
          echo "  - Security Scan: ${{ needs.security-scan.result }}"
          echo "  - Config Validation: ${{ needs.validate-config.result }}"
          echo "  - Tests: ${{ needs.test.result }}"
          echo "  - Build Check: ${{ needs.build-check.result }}"
        continue-on-error: true
